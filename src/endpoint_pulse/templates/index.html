<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme == 'dark' else 'light' }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Endpoint Pulse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link href="/static/css/style.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-expand-lg {% if theme == 'dark' %}navbar-dark bg-dark{% else %}navbar-light bg-light{% endif %}">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Endpoint Pulse</a>
      <div class="ms-auto d-flex gap-2">
        
        <button type="button" class="btn btn-sm {% if theme == 'dark' %}btn-outline-light{% else %}btn-outline-dark{% endif %}" data-bs-toggle="modal" data-bs-target="#preferencesModal">
          <i class="bi bi-gear"></i> Preferences
        </button>
        <button type="button" class="btn btn-sm {% if theme == 'dark' %}btn-outline-light{% else %}btn-outline-dark{% endif %}" data-bs-toggle="modal" data-bs-target="#aboutModal" title="About this app">
          <i class="bi bi-info-circle"></i> About
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid my-3">

    <div class="row g-3">
      <!-- Left: Tree -->
      <div class="col-12 col-md-3 col-lg-2">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Folders</span>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#confirmResetModal">Reset</button>
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addFolderModal">
                <i class="bi bi-plus-lg"></i> Add
              </button>
            </div>
          </div>
          <div class="card-body p-2">
            {% if folders and folders|length > 0 %}
              <ul class="list-unstyled mb-0">
                {% for folder in folders %}
                  <li class="mb-2">
                    <details {% if selected_folder and selected_folder.id == folder.id %}open{% endif %}>
                      <summary class="d-flex justify-content-between align-items-center">
                        <span class="d-inline-flex align-items-center">
                          <span class="me-1">
                            <i class="bi bi-caret-right-fill when-closed" aria-hidden="true"></i>
                            <i class="bi bi-caret-down-fill when-open" aria-hidden="true"></i>
                          </span>
                          <a href="/?folder_id={{ folder.id }}" class="text-decoration-none{% if selected_folder and selected_folder.id == folder.id %} fw-bold{% endif %}">{{ folder.name }}</a>
                        </span>
                        <span class="d-inline-flex align-items-center gap-2">
                          <span class="badge rounded-pill bg-secondary" title="Number of URLs in this folder">{{ folder.nodes|length if folder.nodes else 0 }}</span>
                          <form method="post" action="/folders/{{ folder.id }}/test/html" class="m-0">
                            <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1" title="Test all" aria-label="Test all">
                              <i class="bi bi-play-fill"></i>
                            </button>
                          </form>
                        </span>
                      </summary>
                      {% if folder.nodes and folder.nodes|length > 0 %}
                        <ul class="list-unstyled ms-5 mt-2">
                          {% for node in folder.nodes %}
                            <li class="mb-1 d-flex justify-content-between align-items-center">
                              <span>
                                <a href="/?node_id={{ node.id }}" class="text-decoration-none{% if selected_node and selected_node.id == node.id %} fw-bold{% endif %}">{{ node.name }}</a>
                              </span>
                              <span class="d-inline-flex align-items-center gap-2">
                                <form method="post" action="/nodes/{{ node.id }}/toggle_active" class="m-0">
                                  <button type="submit" class="badge {% if node.active %}bg-success{% else %}bg-secondary{% endif %} border-0" title="Click to toggle active/inactive">
                                    {{ 'active' if node.active else 'inactive' }}
                                  </button>
                                </form>
                                <form method="post" action="/nodes/{{ node.id }}/test/html" class="m-0">
                                  <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1" title="Test" aria-label="Test">
                                    <i class="bi bi-play-fill"></i>
                                  </button>
                                </form>
                              </span>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <div class="text-muted small ms-5 mt-2">No nodes</div>
                      {% endif %}
                    </details>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted small">No folders yet.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Right: Contextual Forms -->
      <div class="col-12 col-md-8 col-lg-9">
        <div class="card">
          <div class="card-header">
            {% if selected_node %}
              Edit Node
            {% elif selected_folder %}
              Folder: {{ selected_folder.name }}
            {% else %}
              Add Folder
            {% endif %}
          </div>
          <div class="card-body">
            {% if not selected_folder and not selected_node %}
              <form method="post" action="/folders/add" class="row g-2">
                <div class="col-md-8">
                  <label class="form-label" for="folder-name">Folder name</label>
                  <input id="folder-name" name="name" class="form-control" placeholder="e.g., Production" required minlength="1" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary">Add Folder</button>
                </div>
              </form>
            {% elif selected_folder and not selected_node %}
              <!-- Rename/Delete folder -->
              <div class="row g-2 mb-3 align-items-end">
                <div class="col-md-8">
                  <label class="form-label">Rename folder</label>
                  <form method="post" action="/folders/{{ selected_folder.id }}/rename" class="d-flex gap-2">
                    <input name="name" class="form-control" value="{{ selected_folder.name }}" required minlength="1" />
                    <button type="submit" class="btn btn-success">Save</button>
                  </form>
                </div>
                <div class="col-md-4 d-flex gap-2">
                  <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteFolder-{{ selected_folder.id }}">Delete</button>
                  <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#confirmDuplicateFolder-{{ selected_folder.id }}">Duplicate</button>

                  <!-- Delete Folder Modal -->
                  <div class="modal fade" id="confirmDeleteFolder-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="confirmDeleteFolderLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="confirmDeleteFolderLabel-{{ selected_folder.id }}">Delete Folder</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete the folder "{{ selected_folder.name }}" and all of its URLs? This action cannot be undone.
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="/folders/{{ selected_folder.id }}/delete" class="m-0">
                            <button type="submit" class="btn btn-danger">Delete</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Duplicate Folder Modal -->
                  <div class="modal fade" id="confirmDuplicateFolder-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="confirmDuplicateFolderLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="confirmDuplicateFolderLabel-{{ selected_folder.id }}">Duplicate Folder</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Create a copy of the folder "{{ selected_folder.name }}" and all of its URLs?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="/folders/{{ selected_folder.id }}/duplicate" class="m-0">
                            <button type="submit" class="btn btn-secondary">Duplicate</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Node in this folder -->
              <div class="border rounded p-3">
                <div class="fw-semibold mb-2">Add Node</div>
                <form method="post" action="/nodes/add" class="row g-2">
                  <input type="hidden" name="folder_id" value="{{ selected_folder.id }}" />
                  <div class="col-md-3">
                    <label class="form-label">Name</label>
                    <input name="name" class="form-control" placeholder="e.g., Homepage" required minlength="1" />
                  </div>
                  <div class="col-md-5">
                    <label class="form-label">URL</label>
                    <input name="url" class="form-control" placeholder="https://example.com" required type="url" pattern="https?://.+" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Comment</label>
                    <input name="comment" class="form-control" placeholder="optional" />
                  </div>
                  <div class="col-md-1 form-check d-flex align-items-end">
                    <input class="form-check-input form-check-lg" type="checkbox" id="add-active-{{ selected_folder.id }}" name="active" checked>
                    <label class="form-check-label ms-1" for="add-active-{{ selected_folder.id }}">Active</label>
                  </div>
                  <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Add</button>
                  </div>
                </form>
              </div>

              <!-- Nodes table for this folder -->
              <div class="border rounded p-3 mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="fw-semibold">URLs in "{{ selected_folder.name }}"</div>
                  {% if selected_folder.nodes and selected_folder.nodes|length > 0 %}
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" title="Delete selected URLs" id="delete-selected-btn" data-bs-toggle="modal" data-bs-target="#confirmDeleteSelected-{{ selected_folder.id }}">
                      <i class="bi bi-trash"></i> Delete selected
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteAllInFolder-{{ selected_folder.id }}" title="Delete all URLs in this folder">
                      <i class="bi bi-trash3"></i> Delete all
                    </button>
                  </div>
                  {% endif %}
                </div>
                {% if selected_folder.nodes and selected_folder.nodes|length > 0 %}
                  <!-- Standalone forms (no nested forms) -->
                  <form method="post" action="/nodes/bulk_delete" id="bulkDeleteForm">
                    <input type="hidden" name="folder_id" value="{{ selected_folder.id }}" />
                  </form>
                  <form method="post" action="/folders/{{ selected_folder.id }}/test_selected/html" id="testSelectedForm"></form>
                  
                  <!-- Delete Selected Modal -->
                  <div class="modal fade" id="confirmDeleteSelected-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="confirmDeleteSelectedLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="confirmDeleteSelectedLabel-{{ selected_folder.id }}">Delete selected URLs</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete the selected URLs from the folder "{{ selected_folder.name }}"? This action cannot be undone.
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <!-- Submit the existing bulkDeleteForm which carries selected node_ids -->
                          <button type="submit" class="btn btn-danger" form="bulkDeleteForm">Delete selected</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row g-2 align-items-center mb-2">
                    <div class="col-12 col-md-6 ms-auto">
                      <input type="search" id="nodes-search" class="form-control form-control-sm" placeholder="Search name, URL, active/inactive..." aria-label="Search URLs" />
                    </div>
                  </div>
                  <div class="table-responsive">
                      <table class="table table-sm table-hover align-middle" id="nodes-table">
                        <thead>
                          <tr>
                            <th style="width: 2%">
                              <input class="form-check-input" type="checkbox" id="select-all">
                            </th>
                            <th style="width: 18%">Name</th>
                            <th style="width: 42%">URL</th>
                            <th style="width: 25%">Comment</th>
                            <th style="width: 10%">Active</th>
                            <th style="width: 5%" class="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for node in selected_folder.nodes %}
                            <tr data-name="{{ node.name|lower }}" data-url="{{ node.url|lower }}" data-active="{{ 'active' if node.active else 'inactive' }}">
                              <td>
                                <input class="form-check-input node-checkbox" type="checkbox" name="node_ids" value="{{ node.id }}" form="bulkDeleteForm">
                              </td>
                              <td class="text-nowrap"><a href="/?node_id={{ node.id }}" class="text-decoration-none">{{ node.name }}</a></td>
                              <td class="text-truncate" style="max-width: 460px"><a href="{{ node.url }}" target="_blank" rel="noopener">{{ node.url }}</a></td>
                              <td class="small text-muted">{{ node.comment }}</td>
                              <td>
                                <form method="post" action="/nodes/{{ node.id }}/toggle_active" class="d-inline">
                                  <button type="submit" class="badge {% if node.active %}bg-success{% else %}bg-secondary{% endif %} border-0" title="Click to toggle active/inactive">
                                    {{ 'active' if node.active else 'inactive' }}
                                  </button>
                                </form>
                              </td>
                              <td class="text-end text-nowrap">
                                <form method="post" action="/nodes/{{ node.id }}/test/html" class="d-inline">
                                  <input type="hidden" name="keep_folder_context" value="1" />
                                  <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1" title="Test" aria-label="Test">
                                    <i class="bi bi-play-fill"></i>
                                  </button>
                                </form>
                                <form method="post" action="/nodes/{{ node.id }}/duplicate" class="d-inline ms-1">
                                  <input type="hidden" name="keep_folder_context" value="1" />
                                  <button type="submit" class="btn btn-sm btn-outline-secondary p-0 px-1" title="Duplicate" aria-label="Duplicate">
                                    <i class="bi bi-files"></i>
                                  </button>
                                </form>
                                <button type="button" class="btn btn-sm btn-outline-danger p-0 px-1 ms-1" title="Delete" aria-label="Delete" data-bs-toggle="modal" data-bs-target="#confirmDeleteNodeRow-{{ node.id }}">
                                  <i class="bi bi-trash"></i>
                                </button>

                                <!-- Delete Node (row) Modal -->
                                <div class="modal fade" id="confirmDeleteNodeRow-{{ node.id }}" tabindex="-1" aria-labelledby="confirmDeleteNodeRowLabel-{{ node.id }}" aria-hidden="true">
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title" id="confirmDeleteNodeRowLabel-{{ node.id }}">Delete URL</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                      </div>
                                      <div class="modal-body">
                                        Are you sure you want to delete the URL &quot;{{ node.name }}&quot;? This action cannot be undone.
                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <form method="post" action="/nodes/{{ node.id }}/delete" class="m-0">
                                          <button type="submit" class="btn btn-danger">Delete</button>
                                        </form>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                  <!-- Delete All in Folder Modal -->
                  <div class="modal fade" id="confirmDeleteAllInFolder-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="confirmDeleteAllInFolderLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="confirmDeleteAllInFolderLabel-{{ selected_folder.id }}">Delete all URLs</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete ALL URLs in the folder "{{ selected_folder.name }}"? This cannot be undone.
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="/nodes/bulk_delete" class="m-0">
                            <input type="hidden" name="folder_id" value="{{ selected_folder.id }}" />
                            <input type="hidden" name="delete_all_in_folder" value="1" />
                            <button type="submit" class="btn btn-danger">Delete all</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end align-items-center gap-2 mt-2">
                    <form method="post" action="/folders/{{ selected_folder.id }}/test/html" class="d-inline">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-fill"></i> Test all URLs
                      </button>
                    </form>
                    <button type="button" class="btn btn-outline-primary" id="test-selected-btn" title="Test selected URLs">
                      <i class="bi bi-play-fill"></i> Test selected URLs
                    </button>
                    <button type="button" class="btn btn-outline-primary runs-open-btn" data-bs-toggle="modal" data-bs-target="#runsModal-{{ selected_folder.id }}" data-runs-input="#runs-input-{{ selected_folder.id }}" title="Run tests multiple times">
                      <i class="bi bi-repeat"></i> Run tests multiple times…
                    </button>
                    <button type="button" class="btn btn-outline-primary runs-selected-open-btn" data-bs-toggle="modal" data-bs-target="#runsSelectedModal-{{ selected_folder.id }}" data-runs-input="#runs-selected-input-{{ selected_folder.id }}" title="Run selected multiple times">
                      <i class="bi bi-repeat"></i> Run selected multiple times…
                    </button>
                  </div>

                  <!-- Runs (All Tests...) Modal -->
                  <div class="modal fade" id="runsModal-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="runsModalLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="runsModalLabel-{{ selected_folder.id }}">Run Tests</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" action="/folders/{{ selected_folder.id }}/test/html">
                          <div class="modal-body">
                            <label for="runs-input-{{ selected_folder.id }}" class="form-label">Number of runs</label>
                            <input type="number" class="form-control" id="runs-input-{{ selected_folder.id }}" name="runs" value="5" min="1" max="100" />
                            <div class="form-text">Default 5. Runs all active URLs in parallel per run and aggregates results in the chart. The table shows the last run.</div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary runs-submit-btn">Run Tests</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Runs (Selected Tests...) Modal -->
                  <div class="modal fade" id="runsSelectedModal-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="runsSelectedModalLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="runsSelectedModalLabel-{{ selected_folder.id }}">Run Selected Tests</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" action="/folders/{{ selected_folder.id }}/test_selected/html" id="runsSelectedForm-{{ selected_folder.id }}">
                          <div class="modal-body">
                            <label for="runs-selected-input-{{ selected_folder.id }}" class="form-label">Number of runs</label>
                            <input type="number" class="form-control" id="runs-selected-input-{{ selected_folder.id }}" name="runs" value="5" min="1" max="100" />
                            <div class="form-text">Runs only the selected active URLs per run and aggregates results. The table shows the last run.</div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary runs-selected-submit-btn">Run Selected</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <div class="text-muted">No URLs in this folder yet.</div>
                {% endif %}
              </div>
            {% elif selected_node %}
              <!-- Edit Node -->
              <form method="post" action="/nodes/{{ selected_node.id }}/edit" class="row g-2 mb-3">
                <div class="col-md-3">
                  <label class="form-label">Name</label>
                  <input name="name" class="form-control" value="{{ selected_node.name }}" required minlength="1" />
                </div>
                <div class="col-md-5">
                  <label class="form-label">URL</label>
                  <input name="url" class="form-control" value="{{ selected_node.url }}" required type="url" pattern="https?://.+" />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Comment</label>
                  <input name="comment" class="form-control" value="{{ selected_node.comment }}" />
                </div>
                <div class="col-md-1 form-check d-flex align-items-end">
                  <input class="form-check-input form-check-lg" type="checkbox" id="active-{{ selected_node.id }}" name="active" {% if selected_node.active %}checked{% endif %}>
                  <label class="form-check-label ms-1" for="active-{{ selected_node.id }}">Active</label>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                  <button type="submit" class="btn btn-success">Save</button>
                </div>
              </form>
              <div class="d-flex gap-2">
                <form method="post" action="/nodes/{{ selected_node.id }}/test/html" class="m-0">
                  <button type="submit" class="btn btn-primary"><i class="bi bi-play-fill"></i> Test</button>
                </form>
                <form method="post" action="/nodes/{{ selected_node.id }}/duplicate" class="m-0">
                  <button type="submit" class="btn btn-outline-secondary">Duplicate</button>
                </form>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteNode-{{ selected_node.id }}">Delete</button>

                <!-- Delete Node Modal -->
                <div class="modal fade" id="confirmDeleteNode-{{ selected_node.id }}" tabindex="-1" aria-labelledby="confirmDeleteNodeLabel-{{ selected_node.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="confirmDeleteNodeLabel-{{ selected_node.id }}">Delete Node</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        Are you sure you want to delete the URL "{{ selected_node.name }}"? This action cannot be undone.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="post" action="/nodes/{{ selected_node.id }}/delete" class="m-0">
                          <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}

            {% if test_results is defined %}
              <div class="card mt-3">
                <div class="card-header">Test Results</div>
                <div class="card-body">
                  {% if runs is defined and runs > 1 %}
                  <div class="small text-muted">Showing last run out of {{ runs }} total runs.</div>
                  {% endif %}
                  <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0" id="test-results-table">
                      <thead>
                        <tr>
                          <th role="button" data-sort="name" title="Sort by Name">Name</th>
                          <th role="button" data-sort="url" title="Sort by URL">URL</th>
                          <th role="button" data-sort="active" title="Sort by Active">Active</th>
                          <th role="button" data-sort="fetch" title="Sort by Fetch">Fetch</th>
                          <th role="button" data-sort="status" title="Sort by Status">Status</th>
                          <th role="button" data-sort="ok" title="Sort by OK">OK</th>
                          <th role="button" data-sort="elapsed" title="Sort by Response time">Response time</th>
                          <th role="button" data-sort="avg" title="Sort by Average">Avg</th>
                          <th role="button" data-sort="min" title="Sort by Min">Min–Max</th>
                          <th role="button" data-sort="errors" title="Sort by # errors"># errors</th>
                          <th role="button" data-sort="error" title="Sort by Error">Error</th>
                          <th role="button" data-sort="ssl_valid" title="Sort by Cert valid">Cert</th>
                          <th role="button" data-sort="ssl_days_left" title="Sort by Cert valid for">Cert valid for</th>
                          <th role="button" data-sort="ssl_error" title="Sort by SSL issue">SSL Issue</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in test_results %}
                          <tr data-name="{{ (r.name or '')|lower }}"
                              data-url="{{ (r.url or '')|lower }}"
                              data-active="{{ 1 if r.active else 0 }}"
                              data-fetch="{{ r.fetch or '' }}"
                              data-status="{{ r.status_code if r.status_code is defined and r.status_code is not none else '' }}"
                              data-ok="{{ 1 if r.ok else (0 if r.ok is defined else '') }}"
                              data-elapsed="{{ r.elapsed_ms if r.elapsed_ms is defined and r.elapsed_ms is not none else '' }}"
                              data-avg="{{ r.avg_ms if r.avg_ms is defined and r.avg_ms is not none else '' }}"
                              data-min="{{ r.min_ms if r.min_ms is defined and r.min_ms is not none else '' }}"
                              data-max="{{ r.max_ms if r.max_ms is defined and r.max_ms is not none else '' }}"
                              data-error="{{ (r.error or r.reason or '')|lower }}"
                              data-errors="{{ r.errors if r.errors is defined and r.errors is not none else '' }}"
                              data-ssl_valid="{{ (1 if r.ssl_valid else (0 if r.ssl_valid is not none else '')) if r.ssl_valid is defined else '' }}"
                              data-ssl_expires_at="{{ r.ssl_expires_at if r.ssl_expires_at is defined and r.ssl_expires_at is not none else '' }}"
                              data-ssl_days_left="{{ r.ssl_days_left if r.ssl_days_left is defined and r.ssl_days_left is not none else '' }}"
                              data-ssl_error="{{ (r.ssl_error or '')|lower }}">
                            <td class="text-nowrap">{{ r.name }}</td>
                            <td class="text-truncate" style="max-width: 360px"><a href="{{ r.url }}" target="_blank" rel="noopener">{{ r.url }}</a></td>
                            <td>{% if r.active %}<span class="badge bg-success">active</span>{% else %}<span class="badge bg-secondary">inactive</span>{% endif %}</td>
                            <td>
                                                          {% if r.tested == false %}
                                                            <span class="text-muted" title="Skipped"><i class="bi bi-dash-circle"></i></span>
                                                            <span class="small text-muted ms-1">{{ r.fetch or 'skipped' }}</span>
                                                          {% elif r.status_code is defined or r.error is defined %}
                                                            {% if r.ok %}
                                                              <span class="text-success" title="Success"><i class="bi bi-check-circle-fill"></i></span>
                                                            {% else %}
                                                              <span class="text-danger" title="Error"><i class="bi bi-x-circle-fill"></i></span>
                                                            {% endif %}
                                                            <span class="small text-muted ms-1">{{ r.fetch }}</span>
                                                          {% else %}
                                                            <span class="spinner-border spinner-border-sm text-info" role="status" aria-hidden="true"></span>
                                                            <span class="visually-hidden">Loading...</span>
                                                            <span class="small text-muted ms-1">{{ r.fetch }}</span>
                                                          {% endif %}
                                                        </td>
                            <td>{% if r.status_code %}<span class="badge {% if r.ok %}bg-success{% else %}bg-danger{% endif %}">{{ r.status_code }}</span>{% else %}-{% endif %}</td>
                            <td>{% if r.ok %}<span class="badge bg-success">OK</span>{% elif r.tested == false %}<span class="badge bg-secondary">n/a</span>{% else %}<span class="badge bg-danger">FAIL</span>{% endif %}</td>
                            <td>{% if r.elapsed_ms is defined %}{{ r.elapsed_ms }} ms{% else %}-{% endif %}</td>
                            <td>{% if r.avg_ms is defined %}{{ r.avg_ms }} ms{% else %}-{% endif %}</td>
                            <td>{% if r.min_ms is defined and r.max_ms is defined %}{{ r.min_ms }}–{{ r.max_ms }} ms{% else %}-{% endif %}</td>
                            <td>{% if r.errors is defined %}{{ r.errors }}{% else %}-{% endif %}</td>
                            <td class="small text-muted">{{ r.error if r.error else r.reason }}</td>
                            <td>
                              {% if r.ssl_valid is not defined %}-{% elif r.ssl_valid is none %}<span class="badge bg-secondary">n/a</span>{% elif r.ssl_valid %}<span class="badge bg-success">valid</span>{% else %}<span class="badge bg-danger">invalid</span>{% endif %}
                            </td>
                            <td class="small">{% if r.ssl_days_left is defined %}{{ r.ssl_days_left }} days{% else %}-{% endif %}</td>
                            <td class="small text-muted">{% if r.ssl_error is defined %}{{ r.ssl_error }}{% else %}-{% endif %}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% if chart is defined %}
              <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span>Response time graph</span>
                  <span class="small text-muted">
                    Requests: {{ chart.count_measured }}/{{ chart.count_total }}
                    &middot;
                    Avg: {% if chart.avg_ms is not none %}{{ chart.avg_ms }} ms{% else %}n/a{% endif %}
                    {% if runs is defined and runs > 1 %}&middot; Runs: {{ runs }}{% endif %}
                  </span>
                </div>
                <div class="card-body">
                  <div class="w-100 overflow-auto">
                    {% set _W = chart.width|default(720) %}
                    {% set _H = chart.height|default(220) %}
                    {% set _MR = chart.margin_right|default(12) %}
                    {% set _ML = chart.margin_left|default(48) %}
                    {% set _MT = chart.margin_top|default(12) %}
                    {% set _BL = (chart.baseline_y if chart.baseline_y is defined else (_H - (chart.margin_bottom|default(28)))) %}
                    <svg viewBox="0 0 {{ _W }} {{ _H }}" width="{{ _W }}" height="{{ _H }}">
                      <!-- Grid lines and Y-axis labels -->
                      {% if chart.y_ticks %}
                        {% for t in chart.y_ticks %}
                          <line x1="{{ _ML }}" y1="{{ t.y }}" x2="{{ _W - _MR }}" y2="{{ t.y }}" stroke="var(--bs-border-color)" stroke-width="1" opacity="0.3" />
                          <text x="{{ _ML - 6 }}" y="{{ t.y - 2 }}" fill="var(--bs-secondary-color)" font-size="10" text-anchor="end">{{ t.label }}</text>
                        {% endfor %}
                      {% endif %}

                      <!-- Average line -->
                      {% if chart.avg_y is not none %}
                        <line x1="0" y1="{{ chart.avg_y }}" x2="{{ _W }}" y2="{{ chart.avg_y }}" stroke="var(--bs-danger)" stroke-width="1" stroke-dasharray="4 3" />
                        <text x="{{ _W - _MR }}" y="{{ chart.avg_y - 4 }}" fill="var(--bs-danger)" font-size="10" text-anchor="end">avg {{ chart.avg_ms }} ms</text>
                      {% endif %}

                      <!-- Bars -->
                      {% for b in chart.series %}
                        <rect x="{{ b.x }}" y="{{ b.y }}" width="{{ b.width }}" height="{{ b.height }}" fill="{{ b.color }}">
                          <title>{{ b.label }} — {% if b.ms %}{{ b.ms }} ms{% else %}n/a{% endif %}</title>
                        </rect>
                        <!-- X label (thinned by step) -->
                        {% if b.show_xlabel %}
                        <text x="{{ b.x + (b.width/2) }}" y="{{ _BL + 12 }}" fill="var(--bs-secondary-color)" font-size="9" text-anchor="middle">{{ b.xlabel }}</text>
                        {% endif %}
                      {% endfor %}

                      <!-- Axes -->
                      <line x1="{{ _ML }}" y1="{{ _BL }}" x2="{{ _W - _MR }}" y2="{{ _BL }}" stroke="var(--bs-border-color)" stroke-width="1" />
                      <line x1="{{ _ML }}" y1="{{ _MT }}" x2="{{ _ML }}" y2="{{ _BL }}" stroke="var(--bs-border-color)" stroke-width="1" />
                    </svg>
                  </div>
                  <div class="small text-muted mt-2">
                    <span class="me-3"><span class="badge" style="background:#198754">&nbsp;</span> OK</span>
                    <span class="me-3"><span class="badge" style="background:#dc3545">&nbsp;</span> Error/Fail</span>
                    <span class="me-3"><span class="badge" style="background:#6c757d">&nbsp;</span> Skipped/Inactive</span>
                  </div>
                </div>
              </div>
              {% endif %}
            {% endif %}

            {% if test_result %}
              <div class="alert alert-{{ test_result.kind }} mt-3" role="alert">
                {{ test_result.message }}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Reset Modal -->
  <div class="modal fade" id="confirmResetModal" tabindex="-1" aria-labelledby="confirmResetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmResetModalLabel">Reset View</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          This will reset the selection and return to the start view. No data will be deleted. Continue?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="get" action="/" class="m-0">
            <button type="submit" class="btn btn-primary">Reset</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Folder Modal -->
  <div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="addFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addFolderModalLabel">Add Folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" action="/folders/add" id="addFolderForm">
            <div class="mb-3">
              <label for="add-folder-name" class="form-label">Folder name</label>
              <input id="add-folder-name" name="name" class="form-control" placeholder="e.g., Production" required minlength="1" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="addFolderForm">Add Folder</button>
        </div>
      </div>
    </div>
  </div>

  

  <!-- Preferences Modal -->
  <div class="modal fade" id="preferencesModal" tabindex="-1" aria-labelledby="preferencesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="preferencesModalLabel">Preferences</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="/preferences">
          <div class="modal-body">
            <div class="mb-3">
              <div class="form-check form-switch">
                {% if theme == 'dark' %}
                <input class="form-check-input" type="checkbox" role="switch" id="pref-dark-mode" name="dark_mode" checked>
                {% else %}
                <input class="form-check-input" type="checkbox" role="switch" id="pref-dark-mode" name="dark_mode">
                {% endif %}
                <label class="form-check-label" for="pref-dark-mode">Dark mode</label>
              </div>
            </div>
            <div class="mb-3">
              <label for="pref-timeout" class="form-label">Timeout (seconds)</label>
              <input type="number" min="1" max="120" class="form-control" id="pref-timeout" name="timeout_seconds" value="{{ timeout_seconds or 10 }}" />
              <div class="form-text">Applied to URL fetch operations. Range 1–120 seconds.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">About</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Vibe Coding Experiment. Written by Andreas Jung using PyCharm and GPT-5</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Modal shown during multi-run tests -->
  <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content text-center p-3">
        <div class="modal-body">
          <div class="spinner-border text-primary mb-2" role="status" aria-hidden="true"></div>
          <div id="progressModalMsg" class="small text-muted">Running…</div>
        </div>
      </div>
    </div>
  </div>
 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Sorting for Test Results table
      (function() {
        const table = document.getElementById('test-results-table');
        if (!table) return;
        const tbody = table.querySelector('tbody');
        const ths = table.querySelectorAll('thead th[data-sort]');
        let current = { key: null, dir: 1 };
        function cmp(a, b, key) {
          const av = a.dataset[key];
          const bv = b.dataset[key];
          // numeric if both values look like numbers
          const an = av === '' ? NaN : Number(av);
          const bn = bv === '' ? NaN : Number(bv);
          const bothNumeric = !isNaN(an) && !isNaN(bn);
          if (bothNumeric) return an - bn;
          return String(av).localeCompare(String(bv));
        }
        function sortBy(key) {
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const dir = (current.key === key) ? -current.dir : 1;
          rows.sort((r1, r2) => dir * cmp(r1, r2, key));
          // Re-append in new order
          rows.forEach(r => tbody.appendChild(r));
          current = { key, dir };
          // Update header indicators (basic)
          ths.forEach(th => {
            th.classList.remove('text-primary');
            th.textContent = th.textContent.replace(/\s*[▲▼]$/,'');
          });
          const th = Array.from(ths).find(t => t.dataset.sort === key);
          if (th) {
            th.classList.add('text-primary');
            th.textContent = th.textContent + (dir > 0 ? ' ▲' : ' ▼');
          }
        }
        ths.forEach(th => th.addEventListener('click', () => sortBy(th.dataset.sort)));
      })();
      const selectAll = document.getElementById('select-all');
      const bulkForm = document.getElementById('bulkDeleteForm');
      const deleteBtn = document.getElementById('delete-selected-btn');
      const testSelectedBtn = document.getElementById('test-selected-btn');
      const runsSelectedOpenBtn = document.querySelector('.runs-selected-open-btn');
      const testSelectedForm = document.getElementById('testSelectedForm');
      function nodeCheckboxes() {
        return document.querySelectorAll('input.node-checkbox[form="bulkDeleteForm"]');
      }
      function checkedCount() {
        return document.querySelectorAll('input.node-checkbox[form="bulkDeleteForm"]:checked').length;
      }
      function updateButtonsForSelection() {
        const disabled = checkedCount() === 0;
        if (deleteBtn) deleteBtn.disabled = disabled;
        if (testSelectedBtn) testSelectedBtn.disabled = disabled;
        if (runsSelectedOpenBtn) runsSelectedOpenBtn.disabled = disabled;
      }
      function populateSelectedIntoForm(form) {
        if (!form) return;
        // Remove existing node_ids inputs
        Array.from(form.querySelectorAll('input[name="node_ids"]')).forEach(el => el.remove());
        // Add current selections
        document.querySelectorAll('input.node-checkbox[form="bulkDeleteForm"]:checked').forEach(cb => {
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = 'node_ids';
          inp.value = cb.value;
          form.appendChild(inp);
        });
      }
      if (testSelectedBtn && testSelectedForm) {
        testSelectedBtn.addEventListener('click', function() {
          populateSelectedIntoForm(testSelectedForm);
          if (checkedCount() > 0) testSelectedForm.submit();
        });
      }
      if (bulkForm && selectAll) {
        const checkboxes = nodeCheckboxes();
        selectAll.addEventListener('change', function() {
          nodeCheckboxes().forEach(cb => { cb.checked = selectAll.checked; });
          updateButtonsForSelection();
        });
        checkboxes.forEach(cb => cb.addEventListener('change', function() {
          if (!selectAll) return;
          const total = nodeCheckboxes().length;
          const checked = checkedCount();
          selectAll.indeterminate = checked > 0 && checked < total;
          selectAll.checked = checked === total;
          updateButtonsForSelection();
        }));
        // Initialize indeterminate state
        updateButtonsForSelection();
      }

      // Instant search for the URLs table (folder context)
      const searchInput = document.getElementById('nodes-search');
      const tbody = document.querySelector('#nodes-table tbody');
      function tableRows() {
        return Array.from(tbody ? tbody.querySelectorAll('tr') : []);
      }
      function applyFilter() {
        if (!searchInput || !tbody) return;
        const q = (searchInput.value || '').toLowerCase().trim();
        const terms = q.split(/\s+/).filter(Boolean);
        tableRows().forEach(tr => {
          if (terms.length === 0) {
            tr.style.display = '';
            return;
          }
          const name = tr.dataset.name || '';
          const url = tr.dataset.url || '';
          const active = tr.dataset.active || '';
          const ok = terms.every(t => (
            name.includes(t) ||
            url.includes(t) ||
            t === active
          ));
          tr.style.display = ok ? '' : 'none';
        });
      }
      if (searchInput && tbody) {
        searchInput.addEventListener('input', applyFilter);
      }

      // Dynamic label for "Run Tests n times…" button
      document.querySelectorAll('.runs-open-btn').forEach(btn => {
        const inputSelector = btn.getAttribute('data-runs-input');
        const labelSpan = btn.querySelector('.runs-btn-label');
        function updateLabel(n) {
          const num = parseInt(n, 10);
          const safe = (!isNaN(num) && num > 0) ? num : (labelSpan?.dataset?.default || 5);
          if (labelSpan) labelSpan.textContent = `Run Tests ${safe} times…`;
        }
        const inputEl = inputSelector ? document.querySelector(inputSelector) : null;
        if (inputEl) {
          updateLabel(inputEl.value);
          inputEl.addEventListener('input', () => updateLabel(inputEl.value));
        }
      });

      // Dedicated progress modal (spinner). Show on submit of runs form, but do not disable the runs input so its value is posted.
      document.querySelectorAll('#runsModal-{{ selected_folder.id }} form').forEach(form => {
        form.addEventListener('submit', function() {
          try {
            const submitBtn = form.querySelector('.runs-submit-btn');
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Running…';
            }
            // Compute planned requests: runs * active URLs in table (rough estimate from current view)
            const runsInput = form.querySelector('input[name="runs"]');
            let runsVal = 1;
            if (runsInput) {
              const n = parseInt(runsInput.value, 10);
              runsVal = (!isNaN(n) && n > 0) ? n : 1;
            }
            let activeCount = 0;
            try {
              document.querySelectorAll('#nodes-table tbody tr').forEach(tr => {
                // Count rows that look active (data-active="active"); fallback to badge text
                if (tr.dataset && tr.dataset.active === 'active') activeCount += 1;
                else {
                  const badge = tr.querySelector('td:nth-child(5) .badge');
                  if (badge && /active/i.test(badge.textContent || '')) activeCount += 1;
                }
              });
            } catch {}
            const totalPlanned = runsVal * (activeCount || 0);
            const infoText = (totalPlanned > 0)
              ? `Planning to send ${totalPlanned} requests (${runsVal} runs × ${activeCount} URLs)…`
              : `Running ${runsVal} runs…`;

            // Fill progress modal text
            const msgEl = document.getElementById('progressModalMsg');
            if (msgEl) msgEl.textContent = infoText;
            // Show progress modal (static backdrop)
            const progressEl = document.getElementById('progressModal');
            if (progressEl && window.bootstrap) {
              const pm = new bootstrap.Modal(progressEl, { backdrop: 'static', keyboard: false });
              pm.show();
            }
          } catch (e) {}
        }, { once: true });
      });

      // Progress for runs of selected only; also ensure selected ids are included
      document.querySelectorAll('#runsSelectedModal-{{ selected_folder.id }} form').forEach(form => {
        form.addEventListener('submit', function() {
          try {
            populateSelectedIntoForm(form);
            const submitBtn = form.querySelector('.runs-selected-submit-btn');
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Running…';
            }
            const runsInput = form.querySelector('input[name="runs"]');
            let runsVal = 1;
            if (runsInput) {
              const n = parseInt(runsInput.value, 10);
              runsVal = (!isNaN(n) && n > 0) ? n : 1;
            }
            const selectedIds = Array.from(document.querySelectorAll('input.node-checkbox[form="bulkDeleteForm"]:checked')).map(cb => cb.value);
            const totalPlanned = runsVal * selectedIds.length;
            const infoText = (totalPlanned > 0)
              ? `Planning to send ${totalPlanned} requests (${runsVal} runs × ${selectedIds.length} URLs)…`
              : `Running ${runsVal} runs…`;
            const msgEl = document.getElementById('progressModalMsg');
            if (msgEl) msgEl.textContent = infoText;
            const progressEl = document.getElementById('progressModal');
            if (progressEl && window.bootstrap) {
              const pm = new bootstrap.Modal(progressEl, { backdrop: 'static', keyboard: false });
              pm.show();
            }
          } catch (e) {}
        }, { once: true });
      });

      // Instant apply for Dark Mode in Preferences
      (function() {
        const darkToggle = document.getElementById('pref-dark-mode');
        if (!darkToggle) return;
        function setCookie(name, value, days) {
          try {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            const expires = 'expires=' + d.toUTCString();
            document.cookie = `${name}=${value}; ${expires}; path=/; samesite=lax`;
          } catch (e) {}
        }
        function applyTheme(theme) {
          const html = document.documentElement;
          if (html) html.setAttribute('data-bs-theme', theme);
          // Update navbar colors
          const nav = document.querySelector('.navbar');
          if (nav) {
            nav.classList.remove('navbar-dark','bg-dark','navbar-light','bg-light');
            if (theme === 'dark') nav.classList.add('navbar-dark','bg-dark');
            else nav.classList.add('navbar-light','bg-light');
          }
          // Update outline buttons in the header (Preferences/About)
          document.querySelectorAll('[data-bs-target="#preferencesModal"], [data-bs-target="#aboutModal"]').forEach(btn => {
            btn.classList.remove('btn-outline-light','btn-outline-dark');
            btn.classList.add(theme === 'dark' ? 'btn-outline-light' : 'btn-outline-dark');
          });
        }
        darkToggle.addEventListener('change', function() {
          const theme = darkToggle.checked ? 'dark' : 'light';
          applyTheme(theme);
          // Persist immediately so reload keeps the theme even without pressing Save
          setCookie('theme', theme, 365);
        });
      })();
    });
  </script>
</body>
</html>
