<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme == 'dark' else 'light' }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>URL Availability Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link href="/static/css/style.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-expand-lg {% if theme == 'dark' %}navbar-dark bg-dark{% else %}navbar-light bg-light{% endif %}">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">URL Availability Dashboard</a>
      <div class="ms-auto d-flex gap-2">
        <a href="/export" class="btn btn-sm {% if theme == 'dark' %}btn-outline-light{% else %}btn-outline-dark{% endif %}" title="Export hierarchy as JSON">
          <i class="bi bi-download"></i> Export
        </a>
        <button type="button" class="btn btn-sm {% if theme == 'dark' %}btn-outline-light{% else %}btn-outline-dark{% endif %}" data-bs-toggle="modal" data-bs-target="#importModal" title="Import hierarchy from JSON">
          <i class="bi bi-upload"></i> Import
        </button>
        <button type="button" class="btn btn-sm {% if theme == 'dark' %}btn-outline-light{% else %}btn-outline-dark{% endif %}" data-bs-toggle="modal" data-bs-target="#preferencesModal">
          <i class="bi bi-gear"></i> Preferences
        </button>
        <button type="button" class="btn btn-sm {% if theme == 'dark' %}btn-outline-light{% else %}btn-outline-dark{% endif %}" data-bs-toggle="modal" data-bs-target="#aboutModal" title="About this app">
          <i class="bi bi-info-circle"></i> About
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid my-3">

    <div class="row g-3">
      <!-- Left: Tree -->
      <div class="col-12 col-md-4 col-lg-3">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Folders</span>
            <div class="d-flex gap-2">
              <a href="/" class="btn btn-sm btn-outline-secondary">Reset</a>
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addFolderModal">
                <i class="bi bi-plus-lg"></i> Add
              </button>
            </div>
          </div>
          <div class="card-body p-2">
            {% if folders and folders|length > 0 %}
              <ul class="list-unstyled mb-0">
                {% for folder in folders %}
                  <li class="mb-2">
                    <details {% if selected_folder and selected_folder.id == folder.id %}open{% endif %}>
                      <summary>
                        <a href="/?folder_id={{ folder.id }}" class="text-decoration-none{% if selected_folder and selected_folder.id == folder.id %} fw-bold{% endif %}">{{ folder.name }}</a>
                        <span class="badge rounded-pill bg-secondary ms-2" title="Number of URLs in this folder">{{ folder.nodes|length if folder.nodes else 0 }}</span>
                        <form method="post" action="/folders/{{ folder.id }}/test/html" class="d-inline ms-2">
                          <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1" title="Test all" aria-label="Test all">
                            <i class="bi bi-play-fill"></i>
                          </button>
                        </form>
                      </summary>
                      {% if folder.nodes and folder.nodes|length > 0 %}
                        <ul class="list-unstyled ms-5 mt-2">
                          {% for node in folder.nodes %}
                            <li class="mb-1">
                              <a href="/?node_id={{ node.id }}" class="text-decoration-none{% if selected_node and selected_node.id == node.id %} fw-bold{% endif %}">{{ node.name }}</a>
                              <form method="post" action="/nodes/{{ node.id }}/toggle_active" class="d-inline ms-1">
                                <button type="submit" class="badge {% if node.active %}bg-success{% else %}bg-secondary{% endif %} border-0" title="Click to toggle active/inactive">
                                  {{ 'active' if node.active else 'inactive' }}
                                </button>
                              </form>
                              <form method="post" action="/nodes/{{ node.id }}/test/html" class="d-inline ms-2">
                                <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1" title="Test" aria-label="Test">
                                  <i class="bi bi-play-fill"></i>
                                </button>
                              </form>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <div class="text-muted small ms-5 mt-2">No nodes</div>
                      {% endif %}
                    </details>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted small">No folders yet.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Right: Contextual Forms -->
      <div class="col-12 col-md-8 col-lg-9">
        <div class="card">
          <div class="card-header">
            {% if selected_node %}
              Edit Node
            {% elif selected_folder %}
              Folder: {{ selected_folder.name }}
            {% else %}
              Add Folder
            {% endif %}
          </div>
          <div class="card-body">
            {% if not selected_folder and not selected_node %}
              <form method="post" action="/folders/add" class="row g-2">
                <div class="col-md-8">
                  <label class="form-label" for="folder-name">Folder name</label>
                  <input id="folder-name" name="name" class="form-control" placeholder="e.g., Production" required minlength="1" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary">Add Folder</button>
                </div>
              </form>
            {% elif selected_folder and not selected_node %}
              <!-- Rename/Delete folder -->
              <div class="row g-2 mb-3 align-items-end">
                <div class="col-md-8">
                  <label class="form-label">Rename folder</label>
                  <form method="post" action="/folders/{{ selected_folder.id }}/rename" class="d-flex gap-2">
                    <input name="name" class="form-control" value="{{ selected_folder.name }}" required minlength="1" />
                    <button type="submit" class="btn btn-success">Save</button>
                  </form>
                </div>
                <div class="col-md-4 d-flex gap-2">
                  <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteFolder-{{ selected_folder.id }}">Delete</button>
                  <form method="post" action="/folders/{{ selected_folder.id }}/test/html" class="m-0">
                    <button type="submit" class="btn btn-outline-primary">Test all URLs</button>
                  </form>

                  <!-- Delete Folder Modal -->
                  <div class="modal fade" id="confirmDeleteFolder-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="confirmDeleteFolderLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="confirmDeleteFolderLabel-{{ selected_folder.id }}">Delete Folder</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete the folder "{{ selected_folder.name }}" and all of its URLs? This action cannot be undone.
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="/folders/{{ selected_folder.id }}/delete" class="m-0">
                            <button type="submit" class="btn btn-danger">Delete</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Node in this folder -->
              <div class="border rounded p-3">
                <div class="fw-semibold mb-2">Add Node</div>
                <form method="post" action="/nodes/add" class="row g-2">
                  <input type="hidden" name="folder_id" value="{{ selected_folder.id }}" />
                  <div class="col-md-3">
                    <label class="form-label">Name</label>
                    <input name="name" class="form-control" placeholder="e.g., Homepage" required minlength="1" />
                  </div>
                  <div class="col-md-5">
                    <label class="form-label">URL</label>
                    <input name="url" class="form-control" placeholder="https://example.com" required type="url" pattern="https?://.+" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Comment</label>
                    <input name="comment" class="form-control" placeholder="optional" />
                  </div>
                  <div class="col-md-1 form-check d-flex align-items-end">
                    <input class="form-check-input form-check-lg" type="checkbox" id="add-active-{{ selected_folder.id }}" name="active" checked>
                    <label class="form-check-label ms-1" for="add-active-{{ selected_folder.id }}">Active</label>
                  </div>
                  <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Add</button>
                  </div>
                </form>
              </div>

              <!-- Nodes table for this folder -->
              <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="fw-semibold">URLs in "{{ selected_folder.name }}"</div>
                  {% if selected_folder.nodes and selected_folder.nodes|length > 0 %}
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete selected URLs" id="delete-selected-btn" form="bulkDeleteForm">
                      <i class="bi bi-trash"></i> Delete selected
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteAllInFolder-{{ selected_folder.id }}" title="Delete all URLs in this folder">
                      <i class="bi bi-trash3"></i> Delete all
                    </button>
                  </div>
                  {% endif %}
                </div>
                {% if selected_folder.nodes and selected_folder.nodes|length > 0 %}
                  <!-- Standalone form for bulk delete to avoid nested forms -->
                  <form method="post" action="/nodes/bulk_delete" id="bulkDeleteForm">
                    <input type="hidden" name="folder_id" value="{{ selected_folder.id }}" />
                  </form>
                  <div class="table-responsive">
                      <table class="table table-sm table-hover align-middle" id="nodes-table">
                        <thead>
                          <tr>
                            <th style="width: 2%">
                              <input class="form-check-input" type="checkbox" id="select-all">
                            </th>
                            <th style="width: 18%">Name</th>
                            <th style="width: 42%">URL</th>
                            <th style="width: 25%">Comment</th>
                            <th style="width: 10%">Active</th>
                            <th style="width: 5%" class="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for node in selected_folder.nodes %}
                            <tr>
                              <td>
                                <input class="form-check-input node-checkbox" type="checkbox" name="node_ids" value="{{ node.id }}" form="bulkDeleteForm">
                              </td>
                              <td class="text-nowrap"><a href="/?node_id={{ node.id }}" class="text-decoration-none">{{ node.name }}</a></td>
                              <td class="text-truncate" style="max-width: 460px"><a href="{{ node.url }}" target="_blank" rel="noopener">{{ node.url }}</a></td>
                              <td class="small text-muted">{{ node.comment }}</td>
                              <td>
                                <form method="post" action="/nodes/{{ node.id }}/toggle_active" class="d-inline">
                                  <button type="submit" class="badge {% if node.active %}bg-success{% else %}bg-secondary{% endif %} border-0" title="Click to toggle active/inactive">
                                    {{ 'active' if node.active else 'inactive' }}
                                  </button>
                                </form>
                              </td>
                              <td class="text-end">
                                <form method="post" action="/nodes/{{ node.id }}/test/html" class="d-inline">
                                  <input type="hidden" name="keep_folder_context" value="1" />
                                  <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1" title="Test" aria-label="Test">
                                    <i class="bi bi-play-fill"></i>
                                  </button>
                                </form>
                                <form method="post" action="/nodes/{{ node.id }}/duplicate" class="d-inline ms-1">
                                  <button type="submit" class="btn btn-sm btn-outline-secondary p-0 px-1" title="Duplicate" aria-label="Duplicate">
                                    <i class="bi bi-files"></i>
                                  </button>
                                </form>
                                <button type="button" class="btn btn-sm btn-outline-danger p-0 px-1 ms-1" title="Delete" aria-label="Delete" data-bs-toggle="modal" data-bs-target="#confirmDeleteNodeRow-{{ node.id }}">
                                  <i class="bi bi-trash"></i>
                                </button>

                                <!-- Delete Node (row) Modal -->
                                <div class="modal fade" id="confirmDeleteNodeRow-{{ node.id }}" tabindex="-1" aria-labelledby="confirmDeleteNodeRowLabel-{{ node.id }}" aria-hidden="true">
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title" id="confirmDeleteNodeRowLabel-{{ node.id }}">Delete URL</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                      </div>
                                      <div class="modal-body">
                                        Are you sure you want to delete the URL &quot;{{ node.name }}&quot;? This action cannot be undone.
                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <form method="post" action="/nodes/{{ node.id }}/delete" class="m-0">
                                          <button type="submit" class="btn btn-danger">Delete</button>
                                        </form>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                  <!-- Delete All in Folder Modal -->
                  <div class="modal fade" id="confirmDeleteAllInFolder-{{ selected_folder.id }}" tabindex="-1" aria-labelledby="confirmDeleteAllInFolderLabel-{{ selected_folder.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="confirmDeleteAllInFolderLabel-{{ selected_folder.id }}">Delete all URLs</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete ALL URLs in the folder "{{ selected_folder.name }}"? This cannot be undone.
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="/nodes/bulk_delete" class="m-0">
                            <input type="hidden" name="folder_id" value="{{ selected_folder.id }}" />
                            <input type="hidden" name="delete_all_in_folder" value="1" />
                            <button type="submit" class="btn btn-danger">Delete all</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <div class="text-muted">No URLs in this folder yet.</div>
                {% endif %}
              </div>
            {% elif selected_node %}
              <!-- Edit Node -->
              <form method="post" action="/nodes/{{ selected_node.id }}/edit" class="row g-2 mb-3">
                <div class="col-md-3">
                  <label class="form-label">Name</label>
                  <input name="name" class="form-control" value="{{ selected_node.name }}" required minlength="1" />
                </div>
                <div class="col-md-5">
                  <label class="form-label">URL</label>
                  <input name="url" class="form-control" value="{{ selected_node.url }}" required type="url" pattern="https?://.+" />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Comment</label>
                  <input name="comment" class="form-control" value="{{ selected_node.comment }}" />
                </div>
                <div class="col-md-1 form-check d-flex align-items-end">
                  <input class="form-check-input form-check-lg" type="checkbox" id="active-{{ selected_node.id }}" name="active" {% if selected_node.active %}checked{% endif %}>
                  <label class="form-check-label ms-1" for="active-{{ selected_node.id }}">Active</label>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                  <button type="submit" class="btn btn-success">Save</button>
                </div>
              </form>
              <div class="d-flex gap-2">
                <form method="post" action="/nodes/{{ selected_node.id }}/test/html" class="m-0">
                  <button type="submit" class="btn btn-outline-primary">Test</button>
                </form>
                <form method="post" action="/nodes/{{ selected_node.id }}/duplicate" class="m-0">
                  <button type="submit" class="btn btn-outline-secondary">Duplicate</button>
                </form>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteNode-{{ selected_node.id }}">Delete</button>

                <!-- Delete Node Modal -->
                <div class="modal fade" id="confirmDeleteNode-{{ selected_node.id }}" tabindex="-1" aria-labelledby="confirmDeleteNodeLabel-{{ selected_node.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="confirmDeleteNodeLabel-{{ selected_node.id }}">Delete Node</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        Are you sure you want to delete the URL "{{ selected_node.name }}"? This action cannot be undone.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="post" action="/nodes/{{ selected_node.id }}/delete" class="m-0">
                          <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}

            {% if test_results is defined %}
              <div class="card mt-3">
                <div class="card-header">Test Results</div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>URL</th>
                          <th>Active</th>
                          <th>Fetch</th>
                          <th>Status</th>
                          <th>OK</th>
                          <th>Response time</th>
                          <th>Error</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in test_results %}
                          <tr>
                            <td class="text-nowrap">{{ r.name }}</td>
                            <td class="text-truncate" style="max-width: 360px"><a href="{{ r.url }}" target="_blank" rel="noopener">{{ r.url }}</a></td>
                            <td>{% if r.active %}<span class="badge bg-success">active</span>{% else %}<span class="badge bg-secondary">inactive</span>{% endif %}</td>
                            <td>
                                                          {% if r.tested == false %}
                                                            <span class="text-muted" title="Skipped"><i class="bi bi-dash-circle"></i></span>
                                                            <span class="small text-muted ms-1">{{ r.fetch or 'skipped' }}</span>
                                                          {% elif r.status_code is defined or r.error is defined %}
                                                            {% if r.ok %}
                                                              <span class="text-success" title="Success"><i class="bi bi-check-circle-fill"></i></span>
                                                            {% else %}
                                                              <span class="text-danger" title="Error"><i class="bi bi-x-circle-fill"></i></span>
                                                            {% endif %}
                                                            <span class="small text-muted ms-1">{{ r.fetch }}</span>
                                                          {% else %}
                                                            <span class="spinner-border spinner-border-sm text-info" role="status" aria-hidden="true"></span>
                                                            <span class="visually-hidden">Loading...</span>
                                                            <span class="small text-muted ms-1">{{ r.fetch }}</span>
                                                          {% endif %}
                                                        </td>
                            <td>{% if r.status_code %}<span class="badge {% if r.ok %}bg-success{% else %}bg-danger{% endif %}">{{ r.status_code }}</span>{% else %}-{% endif %}</td>
                            <td>{% if r.ok %}<span class="badge bg-success">OK</span>{% elif r.tested == false %}<span class="badge bg-secondary">n/a</span>{% else %}<span class="badge bg-danger">FAIL</span>{% endif %}</td>
                            <td>{% if r.elapsed_ms is defined %}{{ r.elapsed_ms }} ms{% else %}-{% endif %}</td>
                            <td class="small text-muted">{{ r.error if r.error else r.reason }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% if chart is defined %}
              <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span>Response time graph</span>
                  <span class="small text-muted">
                    Requests: {{ chart.count_measured }}/{{ chart.count_total }}
                    &middot;
                    Avg: {% if chart.avg_ms is not none %}{{ chart.avg_ms }} ms{% else %}n/a{% endif %}
                  </span>
                </div>
                <div class="card-body">
                  <div class="w-100">
                    <svg viewBox="0 0 {{ chart.width }} {{ chart.height }}" width="100%" height="{{ chart.height }}">
                      <!-- Bars -->
                      {% for b in chart.series %}
                        <rect x="{{ b.x }}" y="{{ b.y }}" width="{{ b.width }}" height="{{ b.height }}" fill="{{ b.color }}">
                          <title>{{ b.label }} — {% if b.ms %}{{ b.ms }} ms{% else %}n/a{% endif %}</title>
                        </rect>
                      {% endfor %}
                      <!-- Baseline -->
                      <line x1="0" y1="{{ chart.height }}" x2="{{ chart.width }}" y2="{{ chart.height }}" stroke="var(--bs-border-color)" stroke-width="1" />
                    </svg>
                  </div>
                  <div class="small text-muted mt-2">
                    <span class="me-3"><span class="badge" style="background:#198754">&nbsp;</span> OK</span>
                    <span class="me-3"><span class="badge" style="background:#dc3545">&nbsp;</span> Error/Fail</span>
                    <span class="me-3"><span class="badge" style="background:#6c757d">&nbsp;</span> Skipped/Inactive</span>
                  </div>
                </div>
              </div>
              {% endif %}
            {% endif %}

            {% if test_result %}
              <div class="alert alert-{{ test_result.kind }} mt-3" role="alert">
                {{ test_result.message }}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Folder Modal -->
  <div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="addFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addFolderModalLabel">Add Folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" action="/folders/add" id="addFolderForm">
            <div class="mb-3">
              <label for="add-folder-name" class="form-label">Folder name</label>
              <input id="add-folder-name" name="name" class="form-control" placeholder="e.g., Production" required minlength="1" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="addFolderForm">Add Folder</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">Import Hierarchy</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="/import" enctype="multipart/form-data" id="importForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="import-file" class="form-label">Select JSON file</label>
              <input class="form-control" type="file" id="import-file" name="file" accept="application/json,.json" required />
              <div class="form-text">Import will replace the current folders/URLs. Next IDs will be recalculated.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Import</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Preferences Modal -->
  <div class="modal fade" id="preferencesModal" tabindex="-1" aria-labelledby="preferencesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="preferencesModalLabel">Preferences</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="/preferences">
          <div class="modal-body">
            <div class="mb-3">
              <div class="form-check form-switch">
                {% if theme == 'dark' %}
                <input class="form-check-input" type="checkbox" role="switch" id="pref-dark-mode" name="dark_mode" checked>
                {% else %}
                <input class="form-check-input" type="checkbox" role="switch" id="pref-dark-mode" name="dark_mode">
                {% endif %}
                <label class="form-check-label" for="pref-dark-mode">Dark mode</label>
              </div>
            </div>
            <div class="mb-3">
              <label for="pref-timeout" class="form-label">Timeout (seconds)</label>
              <input type="number" min="1" max="120" class="form-control" id="pref-timeout" name="timeout_seconds" value="{{ timeout_seconds or 10 }}" />
              <div class="form-text">Applied to URL fetch operations. Range 1–120 seconds.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">About</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Vibe Coding Experiment. Written by Andreas Jung using PyCharm and GPT-5</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectAll = document.getElementById('select-all');
      const bulkForm = document.getElementById('bulkDeleteForm');
      const deleteBtn = document.getElementById('delete-selected-btn');
      function nodeCheckboxes() {
        return document.querySelectorAll('input.node-checkbox[form="bulkDeleteForm"]');
      }
      function checkedCount() {
        return document.querySelectorAll('input.node-checkbox[form="bulkDeleteForm"]:checked').length;
      }
      function updateDeleteBtn() {
        if (deleteBtn) deleteBtn.disabled = checkedCount() === 0;
      }
      if (bulkForm && selectAll) {
        const checkboxes = nodeCheckboxes();
        selectAll.addEventListener('change', function() {
          nodeCheckboxes().forEach(cb => { cb.checked = selectAll.checked; });
          updateDeleteBtn();
        });
        checkboxes.forEach(cb => cb.addEventListener('change', function() {
          if (!selectAll) return;
          const total = nodeCheckboxes().length;
          const checked = checkedCount();
          selectAll.indeterminate = checked > 0 && checked < total;
          selectAll.checked = checked === total;
          updateDeleteBtn();
        }));
        // Initialize indeterminate state
        updateDeleteBtn();
      }
    });
  </script>
</body>
</html>
